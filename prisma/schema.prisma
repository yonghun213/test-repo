// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 사용자 & 인증
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String
  role      String   @default("VIEWER") // ADMIN, PM, CONTRIBUTOR, VIEWER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 국가 & 설정
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // MX, CO, CA
  name      String
  currency  String
  timezone  String
  createdAt DateTime @default(now())
}

// 매장
model Store {
  id               String   @id @default(cuid())
  tempName         String?
  officialName     String?
  country          String
  city             String?
  address          String?
  timezone         String
  storePhone       String?
  storeEmail       String?
  
  // 점주 정보
  ownerName        String?
  ownerPhone       String?
  ownerEmail       String?
  ownerAddress     String?
  
  status           String   @default("PLANNING")
  createdBy        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  plannedOpenDates PlannedOpenDate[]
  milestones       Milestone[]
  tasks            Task[]
  files            StoreFile[]
}

model PlannedOpenDate {
  id        String   @id @default(cuid())
  storeId   String
  date      DateTime
  reason    String?
  changedBy String
  createdAt DateTime @default(now())
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// 마일스톤
model Milestone {
  id        String   @id @default(cuid())
  storeId   String
  type      String   // CONTRACT_SIGNED, CONSTRUCTION_START, SOFT_OPEN, GRAND_OPEN, OPEN_DATE
  date      DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// 템플릿
model Template {
  id        String          @id @default(cuid())
  name      String
  version   Int             @default(1)
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  phases    TemplatePhase[]
}

model TemplatePhase {
  id         String         @id @default(cuid())
  templateId String
  name       String
  order      Int
  template   Template       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tasks      TemplateTask[]
}

model TemplateTask {
  id              String        @id @default(cuid())
  phaseId         String
  title           String
  description     String?
  anchorEvent     String        @default("OPEN_DATE")
  offsetDays      Int
  durationDays    Int           @default(1)
  workdayRule     String        @default("CALENDAR_DAYS")
  isMilestone     Boolean       @default(false)
  roleResponsible String?
  order           Int
  phase           TemplatePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
}

// 태스크
model Task {
  id             String           @id @default(cuid())
  storeId        String
  title          String
  description    String?
  phase          String
  ownerUserId    String?
  startDate      DateTime
  dueDate        DateTime
  status         String           @default("NOT_STARTED")
  priority       String           @default("MEDIUM")
  
  sourceType     String           @default("TEMPLATE")
  templateTaskId String?
  manualOverride Boolean          @default(false)
  locked         Boolean          @default(false)
  calendarRule   String           @default("CALENDAR_DAYS")
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  store          Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  dependencies   TaskDependency[] @relation("DependentTask")
  dependents     TaskDependency[] @relation("DependencyTask")
}

model TaskDependency {
  id              String @id @default(cuid())
  taskId          String
  dependsOnTaskId String
  task            Task   @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn       Task   @relation("DependencyTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)
}

// 파일
model StoreFile {
  id          String   @id @default(cuid())
  storeId     String
  fileName    String
  fileType    String
  fileSize    Int
  filePath    String
  storageType String   @default("LOCAL")
  uploadedBy  String
  createdAt   DateTime @default(now())
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// 감사 로그
model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  changedBy  String
  beforeJson String?
  afterJson  String?
  reason     String?
  metadata   String?
  createdAt  DateTime @default(now())
}

// 알림
model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean   @default(false)
  payload   String?
  status    String    @default("PENDING")
  sentAt    DateTime?
  createdAt DateTime  @default(now())
}

// 가격/원가 모듈
model Ingredient {
  id          String         @id @default(cuid())
  nameEn      String
  nameLocal   String?
  unitType    String
  category    String
  createdAt   DateTime       @default(now())
  prices      GroceryPrice[]
  recipeLines RecipeLine[]
}

model GroceryPrice {
  id             String     @id @default(cuid())
  ingredientId   String
  country        String
  retailer       String
  packageSize    Float
  packageUnit    String
  packagePrice   Float
  currency       String
  taxIncluded    Boolean    @default(true)
  normalizedCost Float
  asOf           DateTime
  sourceUrl      String?
  notes          String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  ingredient     Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
}

model Recipe {
  id        String       @id @default(cuid())
  menuItem  String
  version   Int          @default(1)
  country   String?
  yield     Float?
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  lines     RecipeLine[]
}

model RecipeLine {
  id           String     @id @default(cuid())
  recipeId     String
  ingredientId String
  qty          Float
  qtyUnit      String
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
}

model CompetitorPrice {
  id        String   @id @default(cuid())
  country   String
  brand     String
  menuItem  String
  size      String?
  price     Float
  currency  String
  asOf      DateTime
  source    String?
  createdAt DateTime @default(now())
}

model FXRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Float
  asOf         DateTime
  source       String?
  createdAt    DateTime @default(now())
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String
}
